{% extends 'sovtimer/base.html' %}

{% load i18n %}
{% load static %}

{% block sovtimer_header %}
    {% translate "Sovereignty Timer" as translated_header %}
    {% include 'sovtimer/partials/header/h1.html' with header_text=translated_header %}
{% endblock %}

{% block sovtimer_body %}
    {% include 'sovtimer/partials/dashboard/table.html' %}
{% endblock %}

{% block extra_css %}
    {% include 'bundles/datatables-css.html' %}

    <link rel="stylesheet" href="{% static 'sovtimer/css/aa-bootstrap-fix.min.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'sovtimer/css/aa-sov-timer.min.css' %}" type="text/css">
{% endblock %}

{% block extra_javascript %}
    {% include 'bundles/datatables-js.html' %}
    {% include 'bundles/moment-js.html' with locale=True %}

    <script type="application/javascript" src="{% static 'sovtimer/libs/datatables/plugins/dataTables.rowGroup.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'sovtimer/libs/datatables/plugins/datetime.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/filterDropDown/filterDropDown.min.js' %}"></script>

    <script type="application/javascript">
    const DATETIME_FORMAT = 'YYYY-MM-DD HH:mm'

    $(document).ready(function () {
        var sov_campaign_table = $('.aa-sovtimer-campaigns').DataTable({
            ajax: {
                url: "{% url 'sovtimer:dashboard_data' %}",
                dataSrc: '',
                cache: false
            },
            columns: [
                {
                    data: 'event_type',
                    className: "aa-sovtimer-event-type"
                },
                {
                    data: 'solar_system_name',
                    className: "aa-sovtimer-system"
                },
                {
                    data: 'constellation_name',
                    className: "aa-sovtimer-constellation"
                },
                {
                    data: 'region_name',
                    className: "aa-sovtimer-region"
                },
                {
                    data: 'defender_name',
                    className: "aa-sovtimer-defender"
                },
                {#{#}
                {#    data: 'adm', #}
                {#    className: "aa-sovtimer-adm"#}
                {# },#}
                {
                    data: 'start_time',
                    className: "aa-sovtimer-start-time",
                    render: $.fn.dataTable.render.moment(moment.ISO_8601, DATETIME_FORMAT)
                },
                {
                    data: 'remaining',
                    className: "aa-sovtimer-remaining-time",
                    render: function(data, type, row, meta) {
                        $('#time-' + meta.row).html('');

                        var secondsRemaining = data;
                        var isElapsed = false;
                        var prefix = '';

                        if(secondsRemaining <= 0) {
                            isElapsed = true;
                            prefix = '-';
                            secondsRemaining = Math.abs(secondsRemaining)
                        }

                        // set the interval
                        countdownIntervalId = setInterval(function() {
                            // execute code each second
                            $('#time-' + meta.row).html('');

                            if(secondsRemaining <= 0) {
                                isElapsed = true;
                                prefix = '-';
                                secondsRemaining = Math.abs(secondsRemaining)
                            }

                            if(isElapsed === true) {
                                secondsRemaining++; // increment with one second each second
                            } else {
                                secondsRemaining--; // decrement with one second each second
                            }

                            var days    = Math.floor(secondsRemaining / (24 * 60 * 60)); // calculate days from
                            var hours   = Math.floor(secondsRemaining / (60 * 60)) % 24; // hours
                            var minutes = Math.floor(secondsRemaining / 60) % 60; // minutes
                            var seconds = Math.floor(secondsRemaining / 1) % 60; // seconds

                            // leading zero ...
                            if(hours < 10) {hours = '0' + hours;}
                            if(minutes < 10) {minutes = '0' + minutes;}
                            if(seconds < 10) {seconds = '0' + seconds;}

                            var countdown = '';

                            if(isElapsed === true) {
                                countdown += '<span class="aa-sovtimer-remaining aa-sovtimer-timer-elapsed">'
                            } else {
                                countdown += '<span class="aa-sovtimer-remaining ">'
                            }

                            countdown += prefix + days + 'd ' + hours + 'h ' + minutes + 'm ' + seconds + 's';
                            countdown += '</span>';

                            $('#time-' + meta.row).html('');
                            $('#time-' + meta.row).html(countdown);
                        }, 1000);

                        var returnValue = '<span id="time-' + meta.row + '"></span>';

                        return returnValue;
                    }
                },
                {
                    data: 'defender_score',
                    className: "aa-sovtimer-defender-score"
                },
            ],
            order: [[5, "asc"]],
            filterDropDown: {
                columns: [
                    {
                        idx: 0,
                    },
                    {
                        idx: 1,
                    },
                    {
                        idx: 2,
                    },
                    {
                        idx: 3,
                    },
                    {
                        idx: 4,
                    },
                    /*
                    {
                        idx: 5,
                    }
                    */
                ],
                autoSize: false,
                bootstrap: true
            },
            paging: false
        });

        setInterval(function() {
            sov_campaign_table.ajax.reload();
        }, 30000 );
    });
    </script>
{% endblock %}

{% block extra_script %}
{% endblock extra_script %}
